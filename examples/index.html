<!doctype html>
<html>
  <head>
    <meta charset="utf-8">
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.1.1/jquery.min.js"></script>
    <script src="dist/skyway-siru-client.js"></script>
  </head>
  <body>
    <p>
      <h1>skyway-siru-client example</h1>
    </p>
    <p>
      <form>
        <label>apikey</label><input type="text" name="apikey"/></label>
        <label>room name</label><input type="text" name="room-name"/></label>
        <button type="submit">start</button>
      </form>
    </p>
    <p>
      <strong>status : </strong><span id="status"></span>
    </p>
    <p>
      <ul>
        <li>uuid: <span id="uuid"></span></li>
        <li>echo message: <span id="echo-mesg"></span></li>
        <li>published message: <span id="published-mesg"></span></li>
      </ul>
    </p>
    <p>
      <div><strong>video status: </strong><span id="video-status">idle</span></div>
      <button id="stop-video">stop video</button><br/>
      <video id="janusvideo" autoplay></video>
    </p>

    <div id="output">
      <ul id="list"></ul>
    </div>
    <script>
      const __STOREKEY__ = 'skyway-siru-client-sample'

      const conf = JSON.parse(localStorage.getItem(__STOREKEY__))

      if(conf) {
        $("input[name=apikey]").val(conf.apikey)
        $("input[name=room-name]").val(conf.roomName)
      }
      $("#stop-video").prop("disabled", true)

      $("form").on("submit", function(ev) {
        ev.preventDefault()
        $(this).find("button").prop("disabled", true)

        const apikey = $(this).find("input[name=apikey]").val()
          , roomName = $(this).find("input[name=room-name]").val()

        storeLocalStorage({apikey, roomName})
        start(roomName, apikey)
      })

      const storeLocalStorage = param => {
        localStorage.setItem(__STOREKEY__, JSON.stringify(param))
      }

      const start = (roomName, apikey) => {
        const client = new SiRuClient(roomName, {key: apikey})

        updateStatus('connecting...')

        client.on('connect', () => updateStatus('connected'))
        client.on('meta', profile => {
          $("#uuid").text(profile.uuid)
          startStreaming(client, profile)
          startSubscribe(client, profile.topics)
          sendEchoRequest(client, profile.uuid)
        })
      }

      const startStreaming = (client, profile) => {
        $("#video-status").text("requesting")
        client.requestStreaming(profile.uuid)
          .then( stream => {
            $("#video-status").text("started")
            $("video")[0].srcObject = stream

            $("#stop-video")
              .prop("disabled", false)
              .on("click", ev => {
                client.stopStreaming(profile.uuid)
                  .then( () => {
                    console.log('stop video streaming')
                  })
              })
          })
      }

      const startSubscribe = (client, topics) => {
        topics.forEach(topic => {
          client.subscribe(topic.name)
          client.on('message', (topicName, mesg) => $("#published-mesg").text(topicName + " : " + mesg))
        })
      }

      const sendEchoRequest = (client, uuid) => {
        $("#echo-message").text("fetching...")
        client.fetch( uuid + "/echo/hello" )
          .then(res => res.text())
          .then(text => $("#echo-mesg").text("receive : " + text))
          .catch(err => console.warn(err.message))
      }

      const updateStatus = (mesg) => {
        $("#status").text(mesg)
      }
    </script>
  </body>
</html>
